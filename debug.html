<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Trainer Debug Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #00ff00;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px #00ff00;
        }

        .controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #00ff00;
        }

        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin-right: 10px;
            transition: all 0.3s;
        }

        button:hover {
            background: #00cc00;
            box-shadow: 0 0 20px #00ff00;
        }

        button:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
        }

        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 4px;
            margin-left: 10px;
            font-weight: bold;
        }

        .status.disconnected {
            background: #ff4444;
            color: white;
        }

        .status.connected {
            background: #00ff00;
            color: #000;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: #2a2a2a;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
        }

        .panel h2 {
            color: #00ff00;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 8px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .label {
            color: #888;
            font-weight: bold;
        }

        .value {
            color: #00ff00;
            font-weight: bold;
            text-align: right;
        }

        .value.highlight {
            color: #ffff00;
            text-shadow: 0 0 5px #ffff00;
        }

        .log {
            background: #000;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 4px;
            border-left: 3px solid transparent;
        }

        .log-entry.info {
            border-left-color: #00ff00;
            color: #00ff00;
        }

        .log-entry.warn {
            border-left-color: #ffaa00;
            color: #ffaa00;
        }

        .log-entry.error {
            border-left-color: #ff4444;
            color: #ff4444;
        }

        .log-entry.data {
            border-left-color: #00aaff;
            color: #00aaff;
        }

        .hex-dump {
            font-family: 'Courier New', monospace;
            color: #0ff;
            margin: 10px 0;
            padding: 12px;
            background: #111;
            border-radius: 4px;
            border: 1px solid #0ff;
        }

        .hex-row {
            display: grid;
            grid-template-columns: 50px 1fr 200px;
            gap: 15px;
            margin: 3px 0;
            padding: 2px 0;
        }

        .hex-offset {
            color: #666;
            text-align: right;
        }

        .hex-bytes {
            color: #0ff;
            letter-spacing: 2px;
        }

        .hex-bytes .byte {
            display: inline-block;
            margin-right: 4px;
            padding: 1px 3px;
            border-radius: 2px;
        }

        .hex-bytes .byte.flags {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }

        .hex-bytes .byte.power {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6666;
        }

        .hex-bytes .byte.wheel {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
        }

        .hex-bytes .byte.crank {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .hex-bytes .byte.other {
            background: rgba(128, 128, 128, 0.2);
            color: #888;
        }

        .hex-ascii {
            color: #666;
            font-size: 11px;
        }

        .packet-header {
            color: #ffaa00;
            font-weight: bold;
            margin-top: 10px;
            padding: 5px;
            background: rgba(255, 170, 0, 0.1);
            border-left: 3px solid #ffaa00;
        }

        .timestamp {
            color: #666;
            font-size: 11px;
        }

        .metric-big {
            font-size: 48px;
            text-align: center;
            color: #00ff00;
            text-shadow: 0 0 20px #00ff00;
            margin: 20px 0;
        }

        .info-box {
            background: #2a2a2a;
            border: 2px solid #ffaa00;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #ffaa00;
        }

        .info-box h3 {
            margin-bottom: 10px;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff00;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00cc00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö¥ BLE TRAINER DEBUG TOOL üîß</h1>

        <div class="info-box">
            <h3>How to use:</h3>
            <ol>
                <li>Click "Connect Trainer" and select your BLE device</li>
                <li>Start pedaling to generate data</li>
                <li>Watch the raw data panels to see what your trainer sends</li>
                <li>Check the log for detailed parsing information</li>
            </ol>
            <h3 style="margin-top: 15px;">Hex Dump Color Legend:</h3>
            <div style="display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap;">
                <div><span class="byte flags" style="padding: 2px 8px; border-radius: 3px; display: inline-block;">FF</span> Flags</div>
                <div><span class="byte power" style="padding: 2px 8px; border-radius: 3px; display: inline-block;">FF</span> Power</div>
                <div><span class="byte wheel" style="padding: 2px 8px; border-radius: 3px; display: inline-block;">FF</span> Wheel Data</div>
                <div><span class="byte crank" style="padding: 2px 8px; border-radius: 3px; display: inline-block;">FF</span> Crank Data (Cadence)</div>
                <div><span class="byte other" style="padding: 2px 8px; border-radius: 3px; display: inline-block;">FF</span> Other</div>
            </div>
        </div>

        <div class="controls">
            <button id="connectBtn">Connect Trainer</button>
            <button id="disconnectBtn" disabled>Disconnect</button>
            <button id="clearLogBtn">Clear Log</button>
            <span class="status disconnected" id="status">DISCONNECTED</span>
        </div>

        <div class="grid">
            <div class="panel">
                <h2>üìä CURRENT METRICS</h2>
                <div class="metric-big" id="cadenceDisplay">0<small style="font-size:24px"> RPM</small></div>
                <div class="data-row">
                    <span class="label">Power:</span>
                    <span class="value" id="powerValue">0 W</span>
                </div>
                <div class="data-row">
                    <span class="label">Heart Rate:</span>
                    <span class="value" id="hrValue">0 bpm</span>
                </div>
                <div class="data-row">
                    <span class="label">Cadence:</span>
                    <span class="value highlight" id="cadenceValue">0 RPM</span>
                </div>
            </div>

            <div class="panel">
                <h2>üîå DEVICE INFO</h2>
                <div class="data-row">
                    <span class="label">Device Name:</span>
                    <span class="value" id="deviceName">-</span>
                </div>
                <div class="data-row">
                    <span class="label">Device ID:</span>
                    <span class="value" id="deviceId">-</span>
                </div>
                <div class="data-row">
                    <span class="label">GATT Connected:</span>
                    <span class="value" id="gattStatus">No</span>
                </div>
                <div class="data-row">
                    <span class="label">Services Found:</span>
                    <span class="value" id="servicesCount">0</span>
                </div>
            </div>

            <div class="panel">
                <h2>üéØ AVAILABLE SERVICES</h2>
                <div class="data-row">
                    <span class="label">Fitness Machine (FTMS):</span>
                    <span class="value" id="ftmsService">‚ùå</span>
                </div>
                <div class="data-row">
                    <span class="label">Indoor Bike Data:</span>
                    <span class="value" id="indoorBikeChar">‚ùå</span>
                </div>
                <div class="data-row">
                    <span class="label">Cycling Power:</span>
                    <span class="value" id="powerService">‚ùå</span>
                </div>
                <div class="data-row">
                    <span class="label">Cycling Speed/Cadence:</span>
                    <span class="value" id="cscService">‚ùå</span>
                </div>
                <div class="data-row">
                    <span class="label">Heart Rate:</span>
                    <span class="value" id="hrService">‚ùå</span>
                </div>
            </div>

            <div class="panel">
                <h2>‚öôÔ∏è CRANK DATA (Cycling Power)</h2>
                <div class="data-row">
                    <span class="label">Cumulative Revs (16-bit):</span>
                    <span class="value" id="crankRevs16">-</span>
                </div>
                <div class="data-row">
                    <span class="label">Cumulative Revs (32-bit):</span>
                    <span class="value" id="crankRevs32">-</span>
                </div>
                <div class="data-row">
                    <span class="label">Event Time:</span>
                    <span class="value" id="crankTime">-</span>
                </div>
                <div class="data-row">
                    <span class="label">Delta Revs:</span>
                    <span class="value highlight" id="deltaRevs">-</span>
                </div>
                <div class="data-row">
                    <span class="label">Delta Time:</span>
                    <span class="value highlight" id="deltaTime">-</span>
                </div>
                <div class="data-row">
                    <span class="label">Calculated (no √∑2):</span>
                    <span class="value highlight" id="calcCadenceRaw">-</span>
                </div>
                <div class="data-row">
                    <span class="label">Calculated (√∑2):</span>
                    <span class="value highlight" id="calcCadenceDivided">-</span>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>üì° RAW DATA LOG</h2>
            <div class="log" id="logPanel"></div>
        </div>
    </div>

    <script>
        // BLE Service UUIDs
        const FITNESS_MACHINE_SERVICE = 0x1826;
        const CYCLING_POWER_SERVICE = 0x1818;
        const CYCLING_SPEED_CADENCE_SERVICE = 0x1816;
        const HEART_RATE_SERVICE = 0x180D;

        // State
        let device = null;
        let server = null;
        let metrics = { power: 0, hr: 0, cadence: 0 };

        // Crank tracking
        let lastCrankRevs16 = undefined;
        let lastCrankRevs32 = undefined;
        let lastCrankTime = undefined;

        // UI Elements
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const statusEl = document.getElementById('status');
        const logPanel = document.getElementById('logPanel');

        // Event Handlers
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        clearLogBtn.addEventListener('click', () => logPanel.innerHTML = '');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString() + '.' + String(Date.now() % 1000).padStart(3, '0');
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        function updateUI(elementId, value) {
            const el = document.getElementById(elementId);
            if (el) el.textContent = value;
        }

        function hexDump(buffer) {
            const bytes = new Uint8Array(buffer);
            return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
        }

        function fancyHexDump(buffer, annotations = {}) {
            const bytes = new Uint8Array(buffer);
            let html = '<div class="hex-dump">';

            // Split into rows of 8 bytes
            for (let i = 0; i < bytes.length; i += 8) {
                const rowBytes = bytes.slice(i, Math.min(i + 8, bytes.length));

                html += '<div class="hex-row">';

                // Offset
                html += `<div class="hex-offset">${i.toString().padStart(3, '0')}:</div>`;

                // Hex bytes with color coding
                html += '<div class="hex-bytes">';
                for (let j = 0; j < rowBytes.length; j++) {
                    const byteIndex = i + j;
                    const byte = rowBytes[j];
                    const hexByte = byte.toString(16).padStart(2, '0');

                    // Determine color based on annotation
                    let className = 'byte other';
                    if (annotations.flags && byteIndex >= annotations.flags[0] && byteIndex <= annotations.flags[1]) {
                        className = 'byte flags';
                    } else if (annotations.power && byteIndex >= annotations.power[0] && byteIndex <= annotations.power[1]) {
                        className = 'byte power';
                    } else if (annotations.wheel && byteIndex >= annotations.wheel[0] && byteIndex <= annotations.wheel[1]) {
                        className = 'byte wheel';
                    } else if (annotations.crank && byteIndex >= annotations.crank[0] && byteIndex <= annotations.crank[1]) {
                        className = 'byte crank';
                    }

                    html += `<span class="${className}">${hexByte}</span>`;
                }
                html += '</div>';

                // ASCII representation
                html += '<div class="hex-ascii">';
                for (let j = 0; j < rowBytes.length; j++) {
                    const byte = rowBytes[j];
                    const char = (byte >= 32 && byte <= 126) ? String.fromCharCode(byte) : '.';
                    html += char;
                }
                html += '</div>';

                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function binaryFlags(value, bits = 16) {
            return value.toString(2).padStart(bits, '0');
        }

        async function connect() {
            try {
                log('üîç Requesting BLE device...', 'info');

                device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: [FITNESS_MACHINE_SERVICE] },
                        { services: [CYCLING_POWER_SERVICE] },
                        { services: [HEART_RATE_SERVICE] }
                    ],
                    optionalServices: [
                        FITNESS_MACHINE_SERVICE,
                        CYCLING_POWER_SERVICE,
                        CYCLING_SPEED_CADENCE_SERVICE,
                        HEART_RATE_SERVICE
                    ]
                });

                log(`‚úì Device selected: ${device.name}`, 'info');
                updateUI('deviceName', device.name);
                updateUI('deviceId', device.id);

                log('üîó Connecting to GATT server...', 'info');
                server = await device.gatt.connect();

                log('‚úì Connected to GATT server', 'info');
                updateUI('gattStatus', 'Yes');
                statusEl.textContent = 'CONNECTED';
                statusEl.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;

                // Discover services
                await discoverServices();

            } catch (error) {
                log(`‚ùå Connection error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
                log('üîå Disconnected', 'info');
            }
            statusEl.textContent = 'DISCONNECTED';
            statusEl.className = 'status disconnected';
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            updateUI('gattStatus', 'No');
        }

        async function discoverServices() {
            let serviceCount = 0;

            // Try Indoor Bike Data (FTMS)
            try {
                log('üîç Checking for Fitness Machine Service...', 'info');
                const ftmsService = await server.getPrimaryService(FITNESS_MACHINE_SERVICE);
                log('‚úì Found Fitness Machine Service', 'info');
                updateUI('ftmsService', '‚úÖ');
                serviceCount++;

                try {
                    const indoorBikeChar = await ftmsService.getCharacteristic(0x2AD2);
                    log('‚úì Found Indoor Bike Data characteristic', 'info');
                    updateUI('indoorBikeChar', '‚úÖ');

                    indoorBikeChar.addEventListener('characteristicvaluechanged', handleIndoorBikeData);
                    await indoorBikeChar.startNotifications();
                    log('üì° Subscribed to Indoor Bike Data', 'info');
                } catch (e) {
                    log(`‚ö† Indoor Bike Data not available: ${e.message}`, 'warn');
                }
            } catch (e) {
                log(`‚ö† Fitness Machine Service not available: ${e.message}`, 'warn');
            }

            // Try Cycling Power Service
            try {
                log('üîç Checking for Cycling Power Service...', 'info');
                const powerService = await server.getPrimaryService(CYCLING_POWER_SERVICE);
                log('‚úì Found Cycling Power Service', 'info');
                updateUI('powerService', '‚úÖ');
                serviceCount++;

                const powerChar = await powerService.getCharacteristic(0x2a63);
                log('‚úì Found Power Measurement characteristic', 'info');

                powerChar.addEventListener('characteristicvaluechanged', handleCyclingPower);
                await powerChar.startNotifications();
                log('üì° Subscribed to Cycling Power', 'info');
            } catch (e) {
                log(`‚ö† Cycling Power Service not available: ${e.message}`, 'warn');
            }

            // Try CSC Service
            try {
                log('üîç Checking for CSC Service...', 'info');
                const cscService = await server.getPrimaryService(CYCLING_SPEED_CADENCE_SERVICE);
                log('‚úì Found CSC Service', 'info');
                updateUI('cscService', '‚úÖ');
                serviceCount++;

                const cscChar = await cscService.getCharacteristic(0x2A5B);
                log('‚úì Found CSC Measurement characteristic', 'info');

                cscChar.addEventListener('characteristicvaluechanged', handleCSC);
                await cscChar.startNotifications();
                log('üì° Subscribed to CSC', 'info');
            } catch (e) {
                log(`‚ö† CSC Service not available: ${e.message}`, 'warn');
            }

            // Try Heart Rate Service
            try {
                log('üîç Checking for Heart Rate Service...', 'info');
                const hrService = await server.getPrimaryService(HEART_RATE_SERVICE);
                log('‚úì Found Heart Rate Service', 'info');
                updateUI('hrService', '‚úÖ');
                serviceCount++;

                const hrChar = await hrService.getCharacteristic(0x2A37);
                log('‚úì Found Heart Rate Measurement characteristic', 'info');

                hrChar.addEventListener('characteristicvaluechanged', handleHeartRate);
                await hrChar.startNotifications();
                log('üì° Subscribed to Heart Rate', 'info');
            } catch (e) {
                log(`‚ö† Heart Rate Service not available: ${e.message}`, 'warn');
            }

            updateUI('servicesCount', serviceCount);
            log(`‚úì Service discovery complete. Found ${serviceCount} services.`, 'info');
        }

        function handleIndoorBikeData(event) {
            const dv = new DataView(event.target.value.buffer);
            const flags = dv.getUint16(0, true);

            // Calculate annotations for color coding
            let offset = 2;
            const annotations = {
                flags: [0, 1]
            };

            // Speed (bit 0)
            if (flags & 0x01) offset += 2;
            // Average Speed (bit 1)
            if (flags & 0x02) offset += 2;
            // Instantaneous Cadence (bit 2)
            if (flags & 0x04) {
                annotations.crank = [offset, offset + 1];
            }

            log('<div class="packet-header">üì° INDOOR BIKE DATA PACKET</div>', 'data');
            log(fancyHexDump(event.target.value.buffer, annotations), 'data');

            log(`Flags: 0x${flags.toString(16).padStart(4, '0')} (${binaryFlags(flags)})`, 'data');

            offset = 2;
            let cadence = null;

            // Speed (bit 0)
            if (flags & 0x01) {
                const speed = dv.getUint16(offset, true);
                log(`  Speed: ${speed / 100} km/h`, 'data');
                offset += 2;
            }

            // Average Speed (bit 1)
            if (flags & 0x02) {
                offset += 2;
            }

            // Instantaneous Cadence (bit 2)
            if (flags & 0x04) {
                cadence = dv.getUint16(offset, true) / 2; // 0.5 RPM resolution
                log(`  üéØ CADENCE FOUND: ${cadence} RPM`, 'info');
                metrics.cadence = cadence;
                updateMetrics();
                offset += 2;
            }

            // Average Cadence (bit 3)
            if (flags & 0x08) {
                const avgCadence = dv.getUint16(offset, true) / 2;
                log(`  Average Cadence: ${avgCadence} RPM`, 'data');
                offset += 2;
            }

            // Power (bit 6)
            if (flags & 0x40) {
                // Skip other fields to get to power
                let powerOffset = 2;
                if (flags & 0x01) powerOffset += 2;
                if (flags & 0x02) powerOffset += 2;
                if (flags & 0x04) powerOffset += 2;
                if (flags & 0x08) powerOffset += 2;
                if (flags & 0x10) powerOffset += 3;
                if (flags & 0x20) powerOffset += 2;

                const power = dv.getInt16(powerOffset, true);
                log(`  Power: ${power} W`, 'data');
                metrics.power = power;
                updateMetrics();
            }
        }

        function handleCyclingPower(event) {
            const dv = new DataView(event.target.value.buffer);
            const flags = dv.getUint16(0, true);
            const power = dv.getInt16(2, true);

            // Calculate byte positions for color coding
            let offset = 4;
            const annotations = {
                flags: [0, 1],
                power: [2, 3]
            };

            // Skip Pedal Power Balance (bit 0)
            if (flags & 0x01) offset += 1;

            // Skip Accumulated Torque (bit 1)
            if (flags & 0x02) offset += 2;

            // Mark Wheel Revolution Data (bit 2)
            if (flags & 0x04) {
                annotations.wheel = [offset, offset + 5];
                offset += 6;
            }

            // Mark Crank Revolution Data (bit 5 = 0x20)
            if (flags & 0x20 || flags & 0x08) {
                annotations.crank = [offset, offset + 5];
            }

            // Display fancy hex dump with color-coded bytes
            log('<div class="packet-header">üì° CYCLING POWER PACKET</div>', 'data');
            log(fancyHexDump(event.target.value.buffer, annotations), 'data');

            log(`Flags: 0x${flags.toString(16).padStart(4, '0')} (${binaryFlags(flags)})`, 'data');
            log(`Power: ${power} W`, 'data');

            metrics.power = power;
            updateMetrics();

            // Parse flags
            const flagDetails = [];
            if (flags & 0x01) flagDetails.push('Pedal Power Balance');
            if (flags & 0x02) flagDetails.push('Accumulated Torque');
            if (flags & 0x04) flagDetails.push('Wheel Revolution Data');
            if (flags & 0x08) flagDetails.push('Crank Revolution Data');
            if (flags & 0x10) flagDetails.push('Extreme Force Magnitudes');
            if (flags & 0x20) flagDetails.push('Extreme Torque Magnitudes');

            if (flagDetails.length > 0) {
                log(`  Flags present: ${flagDetails.join(', ')}`, 'data');
            }

            offset = 4;

            // Skip Pedal Power Balance (bit 0)
            if (flags & 0x01) {
                offset += 1;
            }

            // Skip Accumulated Torque (bit 1)
            if (flags & 0x02) {
                offset += 2;
            }

            // Skip Wheel Revolution Data (bit 2)
            if (flags & 0x04) {
                const wheelRevs = dv.getUint32(offset, true);
                const wheelTime = dv.getUint16(offset + 4, true);
                log(`  Wheel Revs: ${wheelRevs}, Time: ${wheelTime} (skipping for crank data)`, 'data');
                offset += 6;
            }

            // Crank Revolution Data (bit 5 = 0x20, NOT bit 3!)
            // NOTE: The spec uses bit 5 for "Extreme Torque", but some use it for crank data
            // We'll check BOTH bit 3 (0x08) and bit 5 (0x20)
            if (flags & 0x20 || flags & 0x08) {
                log(`  üéØ Crank Revolution Data Present!`, 'info');

                // Try both 16-bit and 32-bit interpretations
                const revs16 = dv.getUint16(offset, true);
                const time16at2 = dv.getUint16(offset + 2, true);

                let revs32 = null;
                let time32 = null;
                if (event.target.value.buffer.byteLength >= offset + 6) {
                    revs32 = dv.getUint32(offset, true);
                    time32 = dv.getUint16(offset + 4, true);
                }

                log(`  16-bit format: Revs=${revs16}, Time=${time16at2}`, 'data');
                if (revs32 !== null) {
                    log(`  32-bit format: Revs=${revs32}, Time=${time32}`, 'data');
                }

                updateUI('crankRevs16', `${revs16} (0x${revs16.toString(16)})`);
                if (revs32 !== null) {
                    updateUI('crankRevs32', `${revs32} (0x${revs32.toString(16)})`);
                }
                updateUI('crankTime', `${time16at2} (${(time16at2/1024).toFixed(3)}s)`);

                // Calculate cadence using 16-bit
                if (lastCrankRevs16 !== undefined && lastCrankTime !== undefined) {
                    const revDelta16 = (revs16 - lastCrankRevs16) & 0xFFFF;
                    const timeDelta16 = ((time16at2 - lastCrankTime) & 0xFFFF) / 1024.0;

                    if (timeDelta16 > 0 && revDelta16 > 0 && revDelta16 < 50) {
                        const cadenceRaw = Math.round((revDelta16 / timeDelta16) * 60);
                        const cadenceDivided = Math.round(cadenceRaw / 2);

                        log(`  üìä 16-bit: ŒîRevs=${revDelta16}, ŒîTime=${timeDelta16.toFixed(3)}s`, 'info');
                        log(`  üìä Cadence (raw): ${cadenceRaw} RPM`, 'info');
                        log(`  üìä Cadence (√∑2): ${cadenceDivided} RPM`, 'info');

                        updateUI('deltaRevs', revDelta16);
                        updateUI('deltaTime', timeDelta16.toFixed(3) + 's');
                        updateUI('calcCadenceRaw', cadenceRaw + ' RPM');
                        updateUI('calcCadenceDivided', cadenceDivided + ' RPM');

                        // Use raw cadence (no division)
                        metrics.cadence = cadenceRaw;
                        updateMetrics();
                    }
                }

                // Calculate cadence using 32-bit
                if (revs32 !== null && lastCrankRevs32 !== undefined && lastCrankTime !== undefined) {
                    const revDelta32 = revs32 - lastCrankRevs32;
                    const timeDelta32 = ((time32 - lastCrankTime) & 0xFFFF) / 1024.0;

                    if (timeDelta32 > 0 && revDelta32 > 0 && revDelta32 < 50) {
                        const cadenceRaw32 = Math.round((revDelta32 / timeDelta32) * 60);
                        const cadenceDivided32 = Math.round(cadenceRaw32 / 2);

                        log(`  üìä 32-bit: ŒîRevs=${revDelta32}, ŒîTime=${timeDelta32.toFixed(3)}s`, 'info');
                        log(`  üìä 32-bit Cadence (raw): ${cadenceRaw32} RPM`, 'info');
                        log(`  üìä 32-bit Cadence (√∑2): ${cadenceDivided32} RPM`, 'info');
                    }
                }

                lastCrankRevs16 = revs16;
                if (revs32 !== null) {
                    lastCrankRevs32 = revs32;
                }
                lastCrankTime = time16at2;
            }
        }

        function handleCSC(event) {
            const dv = new DataView(event.target.value.buffer);
            const hex = hexDump(event.target.value.buffer);

            log(`<div class="hex-dump">CSC: ${hex}</div>`, 'data');

            const flags = dv.getUint8(0);
            log(`Flags: 0x${flags.toString(16).padStart(2, '0')} (${binaryFlags(flags, 8)})`, 'data');

            let offset = 1;

            // Wheel Revolution Data (bit 0)
            if (flags & 0x01) {
                offset += 6; // Skip wheel data
            }

            // Crank Revolution Data (bit 1)
            if (flags & 0x02) {
                const crankRevs = dv.getUint16(offset, true);
                const crankTime = dv.getUint16(offset + 2, true);

                log(`  üéØ CSC Crank Revs: ${crankRevs}, Time: ${crankTime}`, 'info');

                // Calculate cadence from CSC
                if (lastCrankRevs16 !== undefined && lastCrankTime !== undefined) {
                    const revDelta = (crankRevs - lastCrankRevs16) & 0xFFFF;
                    const timeDelta = ((crankTime - lastCrankTime) & 0xFFFF) / 1024.0;

                    if (timeDelta > 0 && revDelta > 0 && revDelta < 50) {
                        const cadence = Math.round((revDelta / timeDelta) * 60);
                        log(`  üìä CSC Cadence: ${cadence} RPM`, 'info');
                        metrics.cadence = cadence;
                        updateMetrics();
                    }
                }

                lastCrankRevs16 = crankRevs;
                lastCrankTime = crankTime;
            }
        }

        function handleHeartRate(event) {
            const dv = new DataView(event.target.value.buffer);
            const flags = dv.getUint8(0);
            const hr = dv.getUint8(1);

            log(`Heart Rate: ${hr} bpm`, 'data');
            metrics.hr = hr;
            updateMetrics();
        }

        function updateMetrics() {
            updateUI('powerValue', metrics.power + ' W');
            updateUI('hrValue', metrics.hr + ' bpm');
            updateUI('cadenceValue', metrics.cadence + ' RPM');
            updateUI('cadenceDisplay', metrics.cadence);
        }
    </script>
</body>
</html>

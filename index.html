<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zwift Hub Controller</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <i data-lucide="bike" class="header-icon"></i>
                <h1 class="header-title">Zwift Hub Controller</h1>
            </div>
            <div class="header-right">
                <button id="connectBtn" onclick="app.connect()" class="btn btn-primary">
                    <i data-lucide="bluetooth"></i>
                    <span>Connect</span>
                </button>
                <button id="disconnectBtn" onclick="app.disconnect()" disabled class="btn btn-ghost">
                    <i data-lucide="bluetooth-off"></i>
                    <span>Disconnect</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tabs">
        <button class="tab-btn active" onclick="app.switchTab('ride')" id="tab-ride">
            <i data-lucide="bike"></i>
            <span>Ride</span>
        </button>
        <button class="tab-btn" onclick="app.switchTab('design')" id="tab-design">
            <i data-lucide="layout"></i>
            <span>Design</span>
        </button>
        <button class="tab-btn" onclick="app.switchTab('workouts')" id="tab-workouts">
            <i data-lucide="library"></i>
            <span>Workouts</span>
        </button>
        <button class="tab-btn" onclick="app.switchTab('session')" id="tab-session">
            <i data-lucide="users"></i>
            <span>Session</span>
        </button>
    </nav>

    <!-- Ride Tab -->
    <div class="tab-content active" id="content-ride">
        <div class="dashboard">
            <!-- Left Column -->
            <div class="dashboard-main">
                <!-- Metrics -->
                <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <i data-lucide="zap" class="metric-icon"></i>
                        <span class="metric-label">Power</span>
                    </div>
                    <div class="metric-value" id="powerValue">0</div>
                    <div class="metric-footer">watts</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <i data-lucide="heart" class="metric-icon"></i>
                        <span class="metric-label">Heart Rate</span>
                    </div>
                    <div class="metric-value" id="hrValue">0</div>
                    <div class="metric-footer">bpm</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <i data-lucide="gauge" class="metric-icon"></i>
                        <span class="metric-label">Cadence</span>
                    </div>
                    <div class="metric-value" id="cadenceValue">0</div>
                    <div class="metric-footer">rpm</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <i data-lucide="target" class="metric-icon"></i>
                        <span class="metric-label">Target</span>
                    </div>
                    <div class="metric-value" id="targetPowerValue">--</div>
                    <div class="metric-footer">watts</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <i data-lucide="activity" class="metric-icon"></i>
                        <span class="metric-label">Status</span>
                    </div>
                    <div class="metric-value metric-status" id="statusValue">--</div>
                    <div class="metric-footer">connection</div>
                </div>
            </div>

            <!-- Chart -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i data-lucide="line-chart"></i>
                        <span>Live Data</span>
                    </h2>
                </div>
                <div class="card-content">
                    <canvas id="liveChart" width="800" height="300"></canvas>
                </div>
            </div>

            <!-- Active Workout -->
            <div class="card" id="activeWorkoutCard" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">
                        <i data-lucide="play-circle"></i>
                        <span id="activeWorkoutName">Active Workout</span>
                    </h2>
                    <div class="workout-progress-time" id="workoutProgressTime">0:00 / 0:00</div>
                </div>
                <div class="card-content">
                    <div class="active-interval-info">
                        <div class="current-interval">
                            <div class="interval-label">Current</div>
                            <div class="interval-name" id="currentIntervalName">--</div>
                            <div class="interval-target" id="currentIntervalTarget">--</div>
                        </div>
                        <div class="next-interval">
                            <div class="interval-label">Next</div>
                            <div class="interval-name" id="nextIntervalName">--</div>
                            <div class="interval-target" id="nextIntervalTarget">--</div>
                        </div>
                    </div>
                    <canvas id="workoutProgressChart" width="800" height="120"></canvas>

                    <!-- Session Participants (if in session) -->
                    <div id="workoutParticipantsSection" style="display: none;">
                        <div class="workout-participants-header">
                            <i data-lucide="users"></i>
                            <span>Riding Together</span>
                        </div>
                        <div id="workoutParticipantsList" class="workout-participants-list">
                            <!-- Participants will be rendered here -->
                        </div>
                    </div>

                    <div class="workout-controls">
                        <button onclick="workoutDesigner.stopWorkout()" id="stopWorkoutBtn" class="btn btn-danger btn-lg">
                            <i data-lucide="square"></i>
                            <span>Stop Workout</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Workout Summary (after completion) -->
            <div class="card" id="workoutSummaryCard" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">
                        <i data-lucide="check-circle"></i>
                        <span>Workout Complete!</span>
                    </h2>
                </div>
                <div class="card-content">
                    <div class="workout-summary-stats">
                        <div class="summary-stat">
                            <div class="summary-stat-label">Duration</div>
                            <div class="summary-stat-value" id="summaryDuration">--</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-label">Avg Power</div>
                            <div class="summary-stat-value" id="summaryAvgPower">--</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-label">Max Power</div>
                            <div class="summary-stat-value" id="summaryMaxPower">--</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-label">Avg Cadence</div>
                            <div class="summary-stat-value" id="summaryAvgCadence">--</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-label">Total Work</div>
                            <div class="summary-stat-value" id="summaryWork">--</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-label">Avg HR</div>
                            <div class="summary-stat-value" id="summaryAvgHR">--</div>
                        </div>
                    </div>

                    <div class="workout-summary-actions">
                        <button onclick="app.downloadWorkoutTCX()" class="btn btn-primary btn-lg">
                            <i data-lucide="upload"></i>
                            <span>Download TCX for Strava</span>
                        </button>
                        <button onclick="app.downloadWorkoutJSON()" class="btn btn-ghost">
                            <i data-lucide="download"></i>
                            <span>Download JSON</span>
                        </button>
                        <button onclick="app.dismissWorkoutSummary()" class="btn btn-ghost">
                            <i data-lucide="x"></i>
                            <span>Close</span>
                        </button>
                    </div>

                    <div class="workout-summary-help">
                        <p><strong>Upload to Strava:</strong></p>
                        <ol>
                            <li>Download the TCX file above</li>
                            <li>Go to <a href="https://www.strava.com/upload/select" target="_blank" rel="noopener">strava.com/upload/select</a></li>
                            <li>Upload the TCX file</li>
                            <li>Add title, description, and publish!</li>
                        </ol>
                        <p>TCX files also work with Garmin Connect, TrainingPeaks, and most fitness platforms.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="dashboard-sidebar">
            <!-- Quick Control -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i data-lucide="sliders"></i>
                        <span>Quick Control</span>
                    </h2>
                </div>
                <div class="card-content">
                    <div class="control-group">
                        <label class="control-label">Target Power</label>
                        <div class="power-display" id="powerDisplay">100W</div>
                        <input type="range" id="powerSlider" min="0" max="500" value="100" oninput="app.updatePowerDisplay()">
                        <button onclick="app.setPowerCommand()" id="setPowerBtn" disabled class="btn btn-primary btn-block">
                            <i data-lucide="send"></i>
                            <span>Set Power</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Workout Control -->
            <div class="card" id="workoutControlCard" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">
                        <i data-lucide="play-circle"></i>
                        <span>Workout Ready</span>
                    </h2>
                </div>
                <div class="card-content">
                    <button onclick="workoutDesigner.startWorkout()" id="startWorkoutBtn" class="btn btn-primary btn-block btn-lg">
                        <i data-lucide="play"></i>
                        <span>Start Workout</span>
                    </button>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i data-lucide="terminal"></i>
                        <span>Activity Log</span>
                    </h2>
                </div>
                <div class="card-content">
                    <div class="log" id="log"></div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Design Tab -->
    <div class="tab-content" id="content-design">
        <div class="design-container">
            <div class="design-header">
                <h1 class="design-title">Workout Designer</h1>
                <div class="ftp-input-group">
                    <label for="ftpInput" class="ftp-label">FTP:</label>
                    <input type="number" id="ftpInput" value="200" min="50" max="500" onchange="app.updateFTP()">
                    <span class="ftp-unit">W</span>
                </div>
            </div>

            <div class="design-layout">
                <div class="design-main">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i data-lucide="layout"></i>
                                <span>Build Your Workout</span>
                            </h2>
                        </div>
                        <div class="card-content">
                            <div class="toolbar">
                                <button onclick="workoutDesigner.addInterval('warmup')" class="btn btn-sm">
                                    <i data-lucide="sunrise"></i>
                                    <span>Warmup</span>
                                </button>
                                <button onclick="workoutDesigner.addInterval('endurance')" class="btn btn-sm">
                                    <i data-lucide="gauge"></i>
                                    <span>Endurance</span>
                                </button>
                                <button onclick="workoutDesigner.addInterval('tempo')" class="btn btn-sm">
                                    <i data-lucide="trending-up"></i>
                                    <span>Tempo</span>
                                </button>
                                <button onclick="workoutDesigner.addInterval('threshold')" class="btn btn-sm">
                                    <i data-lucide="flame"></i>
                                    <span>Threshold</span>
                                </button>
                                <button onclick="workoutDesigner.addInterval('vo2max')" class="btn btn-sm">
                                    <i data-lucide="rocket"></i>
                                    <span>VO2 Max</span>
                                </button>
                                <button onclick="workoutDesigner.addInterval('cooldown')" class="btn btn-sm">
                                    <i data-lucide="sunset"></i>
                                    <span>Cooldown</span>
                                </button>
                                <div class="toolbar-spacer"></div>
                                <button onclick="workoutDesigner.clearWorkout()" class="btn btn-sm btn-ghost">
                                    <i data-lucide="trash-2"></i>
                                    <span>Clear</span>
                                </button>
                            </div>
                            <div id="workoutTimeline" class="workout-timeline"></div>
                            <div class="workout-stats">
                                <div class="stat">
                                    <i data-lucide="clock"></i>
                                    <span id="totalDuration">0:00</span>
                                </div>
                                <div class="stat">
                                    <i data-lucide="gauge"></i>
                                    <span id="avgPower">0</span>W avg
                                </div>
                                <div class="stat">
                                    <i data-lucide="flame"></i>
                                    <span id="totalWork">0</span>kJ
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="design-sidebar">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i data-lucide="save"></i>
                                <span>Manage</span>
                            </h2>
                        </div>
                        <div class="card-content">
                            <button onclick="app.saveWorkout()" class="btn btn-block">
                                <i data-lucide="save"></i>
                                <span>Save Workout</span>
                            </button>
                            <button onclick="app.exportWorkout()" class="btn btn-block">
                                <i data-lucide="download"></i>
                                <span>Export JSON</span>
                            </button>
                            <button onclick="app.importWorkout()" class="btn btn-block">
                                <i data-lucide="upload"></i>
                                <span>Import JSON</span>
                            </button>
                            <button onclick="app.loadWorkoutForRide()" class="btn btn-primary btn-block">
                                <i data-lucide="play"></i>
                                <span>Load & Ride</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workouts Tab -->
    <div class="tab-content" id="content-workouts">
        <div class="workouts-container">
            <div class="workouts-header">
                <h1 class="workouts-title">Workout Library</h1>
                <button onclick="app.importWorkout()" class="btn btn-primary">
                    <i data-lucide="upload"></i>
                    <span>Import Workout</span>
                </button>
            </div>
            <div id="workoutLibrary" class="workout-library">
                <!-- Workout cards will be generated here -->
            </div>
        </div>
    </div>

    <!-- Session Tab -->
    <div class="tab-content" id="content-session">
        <div class="session-container">
            <div class="session-header">
                <h1 class="session-title">Ride with Friends</h1>
            </div>

            <!-- Not Connected State -->
            <div id="sessionNotConnected" class="session-state">
                <div class="session-intro">
                    <i data-lucide="users" style="width: 64px; height: 64px; margin: 0 auto 1.5rem; color: var(--accent); opacity: 0.5;"></i>
                    <h2>Train Together, Ride Stronger</h2>
                    <p>Create or join a session to ride with friends. See each other's power, cadence, and race on the same workout!</p>
                </div>

                <div class="session-actions">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i data-lucide="plus-circle"></i>
                                <span>Create Session</span>
                            </h2>
                        </div>
                        <div class="card-content">
                            <div class="control-group">
                                <label class="control-label">Your Name</label>
                                <input type="text" id="hostNameInput" placeholder="Enter your name" value="Rider" class="text-input">
                                <button onclick="app.createSession()" class="btn btn-primary btn-block btn-lg">
                                    <i data-lucide="play-circle"></i>
                                    <span>Create Session</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i data-lucide="user-plus"></i>
                                <span>Join Session</span>
                            </h2>
                        </div>
                        <div class="card-content">
                            <div class="control-group">
                                <label class="control-label">Your Name</label>
                                <input type="text" id="joinNameInput" placeholder="Enter your name" value="Rider" class="text-input">
                                <label class="control-label">Session Code</label>
                                <input type="text" id="sessionCodeInput" placeholder="e.g., swift-rider-42-abc123xyz" class="text-input">
                                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0.5rem 0 0 0;">Paste the full session code from your friend</p>
                                <button onclick="app.joinSession()" class="btn btn-primary btn-block btn-lg">
                                    <i data-lucide="log-in"></i>
                                    <span>Join Session</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connected State -->
            <div id="sessionConnected" class="session-state" style="display: none;">
                <div class="session-info-bar">
                    <div class="session-code-display">
                        <span class="label">Session Code:</span>
                        <span class="code" id="sessionCodeDisplay">---</span>
                        <button onclick="app.copySessionInfo()" class="btn btn-sm" title="Copy Session Code">
                            <i data-lucide="copy"></i>
                        </button>
                    </div>
                    <button onclick="app.disconnectSession()" class="btn btn-danger">
                        <i data-lucide="log-out"></i>
                        <span>Leave Session</span>
                    </button>
                </div>

                <!-- My FTP Settings -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i data-lucide="gauge"></i>
                            <span>My FTP</span>
                        </h2>
                    </div>
                    <div class="card-content">
                        <div class="control-group">
                            <label class="control-label">Your FTP (Watts)</label>
                            <div class="ftp-control">
                                <input type="number" id="sessionFtpInput" value="200" min="50" max="500" class="text-input" onchange="app.updateSessionFTP()">
                                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0.5rem 0 0 0;">Workout will scale to your FTP. You can adjust this anytime!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Video Chat Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i data-lucide="video"></i>
                            <span>Video Chat</span>
                        </h2>
                    </div>
                    <div class="card-content">
                        <div class="video-chat-info">
                            <p>Connect with your friends via Google Meet:</p>
                            <div class="control-group">
                                <input type="text" id="meetLinkInput" placeholder="Paste Google Meet link" class="text-input">
                                <button onclick="app.openMeetLink()" class="btn btn-primary btn-block">
                                    <i data-lucide="external-link"></i>
                                    <span>Open Google Meet</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Race Track -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i data-lucide="flag"></i>
                            <span>Race Track</span>
                        </h2>
                    </div>
                    <div class="card-content">
                        <canvas id="raceTrackCanvas" width="1000" height="300"></canvas>
                    </div>
                </div>

                <!-- Participants List -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i data-lucide="users"></i>
                            <span>Participants</span>
                        </h2>
                    </div>
                    <div class="card-content">
                        <div id="participantsList" class="participants-list">
                            <!-- Participants will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Session Controls (Host Only) -->
                <div id="sessionHostControls" class="card" style="display: none;">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i data-lucide="settings"></i>
                            <span>Host Controls</span>
                        </h2>
                    </div>
                    <div class="card-content">
                        <div class="countdown-display" id="countdownDisplay" style="display: none;">
                            <div class="countdown-number" id="countdownNumber">5</div>
                            <div class="countdown-text">Get Ready!</div>
                        </div>
                        <button onclick="app.startSyncedWorkout()" id="startSyncedBtn" class="btn btn-primary btn-block btn-lg">
                            <i data-lucide="play"></i>
                            <span>Start Synchronized Workout (5s countdown)</span>
                        </button>
                        <button onclick="app.endSyncedWorkout()" id="endSyncedBtn" class="btn btn-danger btn-block" style="display: none; margin-top: 0.75rem;">
                            <i data-lucide="square"></i>
                            <span>End Workout for All</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.5/dist/peerjs.min.js"></script>
    <script src="ftms.js"></script>
    <script src="chart.js"></script>
    <script src="workout-preview.js"></script>
    <script src="workout-progress.js"></script>
    <script src="workout-recorder.js"></script>
    <script src="workout-designer.js"></script>
    <script src="hr-zones.js"></script>
    <script src="session.js"></script>
    <script src="racetrack.js"></script>
    <script src="app.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        // Draw workout previews after DOM is loaded
        setTimeout(() => WorkoutPreview.refreshAllPreviews(), 100);
    </script>
</body>
</html>

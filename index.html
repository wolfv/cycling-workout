<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cycling Workout Controller</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.2/dist/basecoat.cdn.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.2/dist/js/all.min.js" defer></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="alpine-store.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="{}">
    <!-- Sidebar Navigation -->
    <aside class="sidebar" data-side="left" aria-hidden="false">
        <nav aria-label="Main navigation">
            <section class="scrollbar">
                <div role="group">
                    <div class="pb-4 border-b border-border">
                        <div class="flex items-center gap-3 mb-4">
                            <i data-lucide="bike" class="w-7 h-7 text-accent"></i>
                            <h2 class="text-xl font-semibold">Cycling Workout</h2>
                        </div>
                        <div class="flex flex-col gap-2" x-data="{}">
                            <button
                                onclick="app.connect()"
                                x-show="!$store.app.connected && !$store.app.connecting"
                                style="display: none;"
                                class="btn-sm w-full bg-blue-600 hover:bg-blue-700 text-white border-blue-600">
                                <i data-lucide="bluetooth"></i>
                                <span>Connect</span>
                            </button>
                            <button
                                x-show="$store.app.connecting"
                                style="display: none;"
                                disabled
                                class="btn-sm-outline w-full">
                                <i data-lucide="loader" class="animate-spin"></i>
                                <span>Connecting...</span>
                            </button>
                            <button
                                onclick="app.disconnect()"
                                x-show="$store.app.connected"
                                style="display: none;"
                                class="btn-sm-outline w-full">
                                <i data-lucide="bluetooth-off"></i>
                                <span>Disconnect</span>
                            </button>
                        </div>
                    </div>

                    <ul>
                        <li>
                            <a href="#" onclick="app.switchTab('ride'); return false;" id="nav-ride" class="active">
                                <i data-lucide="bike"></i>
                                <span>Ride</span>
                            </a>
                        </li>
                        <li>
                        <!-- Group Countdown -->
                        <div id="countdownDisplay" class="ride-countdown" style="display: none;">
                            <div class="ride-countdown-card">
                                <div class="ride-countdown-heading">
                                    <i data-lucide="alarm-clock" class="size-4"></i>
                                    <span>Group Start In</span>
                                </div>
                                <div class="ride-countdown-timer">
                                    <span id="countdownNumber">5</span>
                                    <small>s</small>
                                </div>
                                <p>Stay ready â€“ the workout begins automatically.</p>
                            </div>
                        </div>

                            <a href="#" onclick="app.switchTab('design'); return false;" id="nav-design">
                                <i data-lucide="pencil"></i>
                                <span>Design Workout</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="app.switchTab('workouts'); return false;" id="nav-workouts">
                                <i data-lucide="library"></i>
                                <span>Workouts</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="app.switchTab('session'); return false;" id="nav-session">
                                <i data-lucide="users"></i>
                                <span>Session</span>
                            </a>
                        </li>
                    </ul>

                    <!-- GitHub Link -->
                    <a href="https://github.com/wolfv/zwift-hub-controller" target="_blank" rel="noopener noreferrer"
                       class="flex items-center gap-3 p-3 mx-3 mb-3 rounded-lg hover:bg-accent transition-colors text-muted-foreground hover:text-foreground group border border-border">
                        <i data-lucide="github" class="size-5 group-hover:scale-110 transition-transform"></i>
                        <div class="flex-1 text-sm">
                            <div class="font-medium">Open Source</div>
                            <div class="text-xs opacity-75">Contribute on GitHub</div>
                        </div>
                        <i data-lucide="external-link" class="size-4"></i>
                    </a>
                </div>
            </section>
        </nav>
    </aside>

    <main class="p-8 max-w-[1600px] mx-auto">
        <!-- Mobile sidebar toggle -->
        <div class="p-4 hidden md:hidden" id="mobile-nav-toggle">
            <button type="button" onclick="document.dispatchEvent(new CustomEvent('basecoat:sidebar'))" class="btn-outline">
                <i data-lucide="menu"></i>
                <span>Menu</span>
            </button>
        </div>

        <!-- Ride Tab -->
        <div class="tab-content active" id="content-ride">
        <div class="grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-6 p-6">
            <!-- Main Content -->
            <div class="flex flex-col gap-6">
                <!-- Session Controls -->
                <div class="flex gap-3 items-center justify-end">
                    <!-- Join Session Popover (when not connected) -->
                    <div class="popover" x-show="!$store.app.session.active">
                        <button id="session-popover-trigger" type="button" aria-expanded="false" aria-controls="session-popover-content" class="btn-outline">
                            <i data-lucide="users"></i>
                            <span>Join Session</span>
                        </button>
                        <div id="session-popover-content" data-popover aria-hidden="true" class="w-80">
                            <div class="grid gap-4">
                                <header class="grid gap-1.5">
                                    <h4 class="leading-none font-medium">Join or Create Session</h4>
                                    <p class="text-muted-foreground text-sm">Ride with friends in real-time!</p>
                                </header>
                                <form class="form grid gap-4" onsubmit="app.quickJoinSession(); return false;">
                                    <div class="grid gap-2">
                                        <label for="quickJoinName">Your Name</label>
                                        <input type="text" id="quickJoinName" placeholder="Rider name" value="Rider" class="h-8">
                                    </div>
                                    <div class="grid gap-2">
                                        <label for="quickJoinSessionCode">Session Code</label>
                                        <input type="text" id="quickJoinSessionCode" placeholder="Paste code to join" class="h-8">
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button type="submit" class="btn">
                                            <i data-lucide="users"></i>
                                            Join
                                        </button>
                                        <button type="button" onclick="app.quickCreateSession()" class="btn-outline">
                                            <i data-lucide="plus-circle"></i>
                                            Create New
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metrics -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <div class="bg-card border border-border rounded-lg p-5 transition-all hover:border-border/80 hover:shadow-sm">
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="zap" class="size-4 text-muted-foreground"></i>
                        <span class="text-sm text-muted-foreground font-medium">Power</span>
                    </div>
                    <div class="text-3xl font-bold text-foreground mb-1 tabular-nums" x-text="$store.app.power"></div>
                    <div class="text-xs text-muted-foreground uppercase tracking-wide">watts</div>
                </div>
                <div class="bg-card border border-border rounded-lg p-5 transition-all hover:shadow-sm"
                    :style="{ backgroundColor: $store.app.heartRateBackground, borderColor: $store.app.heartRateBorder }">
                    <div class="flex items-center justify-between gap-2 mb-3">
                        <div class="flex items-center gap-2">
                            <i data-lucide="heart" class="size-4 text-muted-foreground"></i>
                            <span class="text-sm text-muted-foreground font-medium">Heart Rate</span>
                        </div>
                        <span class="text-[0.65rem] font-semibold uppercase tracking-wide px-2 py-1 rounded-full text-white"
                            x-show="$store.app.heartRateZone > 0"
                            style="display: none;"
                            :style="{ backgroundColor: $store.app.heartRateColor }"
                            x-text="'Zone ' + $store.app.heartRateZone"></span>
                    </div>
                    <div class="text-3xl font-bold mb-1 tabular-nums"
                        :style="{ color: $store.app.heartRateZone > 0 ? $store.app.heartRateColor : 'inherit' }"
                        x-text="$store.app.heartRate || '--'"></div>
                    <div class="text-xs text-muted-foreground uppercase tracking-wide flex items-center gap-2">
                        <span>bpm</span>
                        <span class="text-[0.65rem] font-medium capitalize text-muted-foreground"
                            x-show="$store.app.heartRateZoneName"
                            x-text="$store.app.heartRateZoneName"></span>
                    </div>
                </div>
                <div class="bg-card border border-border rounded-lg p-5 transition-all hover:border-border/80 hover:shadow-sm">
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="gauge" class="size-4 text-muted-foreground"></i>
                        <span class="text-sm text-muted-foreground font-medium">Cadence</span>
                    </div>
                    <div class="text-3xl font-bold text-foreground mb-1 tabular-nums" x-text="$store.app.cadence"></div>
                    <div class="text-xs text-muted-foreground uppercase tracking-wide">rpm</div>
                </div>
                <div class="bg-card border border-border rounded-lg p-5 transition-all hover:border-border/80 hover:shadow-sm">
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="target" class="size-4 text-muted-foreground"></i>
                        <span class="text-sm text-muted-foreground font-medium">Target</span>
                    </div>
                    <div class="text-3xl font-bold text-foreground mb-1 tabular-nums" x-text="$store.app.ui.targetPower"></div>
                    <div class="text-xs text-muted-foreground uppercase tracking-wide">watts</div>
                </div>
                <div class="bg-card border border-border rounded-lg p-5 transition-all hover:border-border/80 hover:shadow-sm">
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="activity" class="size-4 text-muted-foreground"></i>
                        <span class="text-sm text-muted-foreground font-medium">Status</span>
                    </div>
                    <div class="text-2xl font-bold text-foreground mb-1" x-text="$store.app.connectionStatus"></div>
                    <div class="text-xs text-muted-foreground uppercase tracking-wide">connection</div>
                </div>
            </div>

            <!-- Live Participants Strip -->
            <div class="card participants-strip" x-show="$store.app.session.active && $store.app.session.participants.length" style="display: none;">
                <div class="participants-strip-header">
                    <div class="participants-strip-title">
                        <i data-lucide="users" class="size-4"></i>
                        <span>Riders Live</span>
                        <span class="participants-strip-count" x-text="$store.app.session.participants.length"></span>
                    </div>
                    <span class="participants-strip-status" x-text="$store.app.session.isHost ? 'You are the host' : 'Following host cues'"></span>
                </div>
                <div class="participants-strip-list" id="participantsStrip">
                    <template x-for="participant in $store.app.session.participants" :key="participant.id">
                        <div class="participant-pill" :class="{ 'participant-pill-host': participant.isHost, 'participant-pill-self': participant.isSelf }"
                            :style="{ backgroundColor: participant.hrBackground, borderColor: participant.hrBorder }">
                            <div class="participant-pill-header">
                                <span class="participant-pill-name" x-text="participant.name"></span>
                                <span class="participant-pill-zone" x-show="participant.zoneLabel" style="display: none;"
                                    :style="{ backgroundColor: participant.hrColor }"
                                    x-text="participant.zoneLabel"></span>
                            </div>
                            <div class="participant-pill-metrics">
                                <span><i data-lucide="zap" class="size-3"></i><span x-text="participant.power"></span><small>W</small></span>
                                <span><i data-lucide="gauge" class="size-3"></i><span x-text="participant.cadence"></span><small>rpm</small></span>
                                <span><i data-lucide="heart" class="size-3"></i><span x-text="participant.heartRate || '--'"></span><small>bpm</small></span>
                            </div>
                            <div class="participant-pill-meta">
                                <span class="participant-pill-ftp" x-text="participant.ftp + 'W FTP'"></span>
                                <span class="participant-pill-role host" x-show="participant.isHost" style="display: none;">Host</span>
                                <span class="participant-pill-role you" x-show="participant.isSelf" style="display: none;">You</span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Chart -->
            <div class="card">
                <header class="border-b border-border">
                    <h2 class="flex items-center gap-2 text-base font-semibold">
                        <i data-lucide="line-chart" class="size-4 text-muted-foreground"></i>
                        <span>Live Data</span>
                    </h2>
                </header>
                <section>
                    <canvas id="liveChart" width="800" height="300" class="w-full h-[300px]"></canvas>
                </section>
            </div>

            <!-- Active Workout -->
            <div class="card" id="activeWorkoutCard" style="display: none;">
                <header class="border-b border-border">
                    <div class="flex items-center justify-between">
                        <h2 class="flex items-center gap-2 text-base font-semibold">
                            <i data-lucide="play-circle" class="size-4 text-muted-foreground"></i>
                            <span id="activeWorkoutName">Active Workout</span>
                        </h2>
                        <div id="workoutProgressTime" class="text-sm font-semibold text-muted-foreground tabular-nums">0:00 / 0:00</div>
                    </div>
                </header>
                <section class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-muted border border-border rounded-md border-l-4 border-l-primary">
                            <div class="text-xs font-semibold text-muted-foreground uppercase tracking-wide mb-2">Current</div>
                            <div id="currentIntervalName" class="text-base font-bold text-foreground mb-1">--</div>
                            <div id="currentIntervalTarget" class="text-sm text-muted-foreground tabular-nums">--</div>
                            <!-- Countdown to next interval -->
                            <div id="currentIntervalCountdown" class="text-xs text-primary font-bold mt-2 tabular-nums" style="display: none;">
                                Next in: <span id="countdownSeconds">--</span>
                            </div>
                        </div>
                        <div class="p-4 bg-muted border border-border rounded-md border-l-4 border-l-muted-foreground">
                            <div class="text-xs font-semibold text-muted-foreground uppercase tracking-wide mb-2">Next</div>
                            <div id="nextIntervalName" class="text-base font-bold text-foreground mb-1">--</div>
                            <div id="nextIntervalTarget" class="text-sm text-muted-foreground tabular-nums">--</div>
                        </div>
                    </div>
                    <canvas id="workoutProgressChart" width="800" height="120" class="w-full h-[120px]"></canvas>

                    <!-- Session Participants (if in session) - Always show if in session -->
                    <div class="border-t border-border pt-4" x-show="$store.app.session.active && $store.app.session.participants.length" style="display: none;">
                        <div class="flex items-center gap-2 text-sm font-semibold text-muted-foreground uppercase tracking-wide mb-3">
                            <i data-lucide="users" class="size-4"></i>
                            <span>Riding Together</span>
                        </div>
                        <div class="space-y-2 max-h-[200px] overflow-y-auto">
                            <template x-for="participant in $store.app.session.participants" :key="participant.id">
                                <div class="workout-participant-compact" :class="{ 'host': participant.isHost }">
                                    <div class="workout-participant-name">
                                        <span x-text="participant.name"></span>
                                        <span class="host-badge-mini" x-show="participant.isHost" style="display: none;">HOST</span>
                                        <span class="host-badge-mini" x-show="participant.isSelf" style="background:#3b82f6;color:#fff; display: none;">YOU</span>
                                    </div>
                                    <div class="workout-participant-stats">
                                        <span class="stat-compact"><i data-lucide="zap"></i><span x-text="participant.power"></span>W</span>
                                        <span class="stat-compact"><i data-lucide="gauge"></i><span x-text="participant.cadence"></span>rpm</span>
                                        <span class="stat-compact"><i data-lucide="heart"></i><span :style="{ color: participant.hrColor }" x-text="participant.heartRate || '--'"></span></span>
                                        <span class="stat-compact ftp-mini" x-text="participant.ftp + 'W FTP'"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="flex justify-center mt-4">
                        <button onclick="workoutDesigner.stopWorkout()" id="stopWorkoutBtn" class="btn-lg-destructive">
                            <i data-lucide="square"></i>
                            <span>Stop Workout</span>
                        </button>
                    </div>
                </section>
            </div>

            <!-- Workout Summary (after completion) -->
            <div class="card" id="workoutSummaryCard" style="display: none;">
                <header class="border-b border-border">
                    <h2 class="flex items-center gap-2 text-base font-semibold">
                        <i data-lucide="check-circle" class="size-4 text-muted-foreground"></i>
                        <span>Workout Complete!</span>
                    </h2>
                </header>
                <section class="space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-muted border border-border rounded-md text-center">
                            <div class="text-xs text-muted-foreground uppercase tracking-wide mb-2">Duration</div>
                            <div id="summaryDuration" class="text-2xl font-bold text-foreground tabular-nums">--</div>
                        </div>
                        <div class="p-4 bg-muted border border-border rounded-md text-center">
                            <div class="text-xs text-muted-foreground uppercase tracking-wide mb-2">Avg Power</div>
                            <div id="summaryAvgPower" class="text-2xl font-bold text-foreground tabular-nums">--</div>
                        </div>
                        <div class="p-4 bg-muted border border-border rounded-md text-center">
                            <div class="text-xs text-muted-foreground uppercase tracking-wide mb-2">Max Power</div>
                            <div id="summaryMaxPower" class="text-2xl font-bold text-foreground tabular-nums">--</div>
                        </div>
                        <div class="p-4 bg-muted border border-border rounded-md text-center">
                            <div class="text-xs text-muted-foreground uppercase tracking-wide mb-2">Avg Cadence</div>
                            <div id="summaryAvgCadence" class="text-2xl font-bold text-foreground tabular-nums">--</div>
                        </div>
                        <div class="p-4 bg-muted border border-border rounded-md text-center">
                            <div class="text-xs text-muted-foreground uppercase tracking-wide mb-2">Total Work</div>
                            <div id="summaryWork" class="text-2xl font-bold text-foreground tabular-nums">--</div>
                        </div>
                        <div class="p-4 bg-muted border border-border rounded-md text-center">
                            <div class="text-xs text-muted-foreground uppercase tracking-wide mb-2">Avg HR</div>
                            <div id="summaryAvgHR" class="text-2xl font-bold text-foreground tabular-nums">--</div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-3">
                        <button onclick="app.downloadWorkoutTCX()" class="btn-lg flex-1">
                            <i data-lucide="upload"></i>
                            <span>Download TCX for Strava</span>
                        </button>
                        <button onclick="app.downloadWorkoutJSON()" class="btn-ghost">
                            <i data-lucide="download"></i>
                            <span>Download JSON</span>
                        </button>
                        <button onclick="app.dismissWorkoutSummary()" class="btn-ghost">
                            <i data-lucide="x"></i>
                            <span>Close</span>
                        </button>
                    </div>

                    <div class="p-4 bg-muted border-l-4 border-l-primary rounded-md space-y-2">
                        <p class="text-sm text-muted-foreground"><strong class="text-foreground">Upload to Strava:</strong></p>
                        <ol class="text-sm text-muted-foreground space-y-1 ml-5 list-decimal">
                            <li>Download the TCX file above</li>
                            <li>Go to <a href="https://www.strava.com/upload/select" target="_blank" rel="noopener" class="text-primary hover:underline">strava.com/upload/select</a></li>
                            <li>Upload the TCX file</li>
                            <li>Add title, description, and publish!</li>
                        </ol>
                        <p class="text-sm text-muted-foreground">TCX files also work with Garmin Connect, TrainingPeaks, and most fitness platforms.</p>
                    </div>
                </section>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="flex flex-col gap-6">
            <!-- Riders (when in session) -->
            <div class="card" x-show="$store.app.session.active" style="display: none;">
                <header>
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="flex items-center gap-2">
                            <i data-lucide="users"></i>
                            <span>Session</span>
                        </h2>
                        <span class="badge badge-success">
                            <i data-lucide="wifi" class="w-3 h-3"></i>
                            Connected
                        </span>
                    </div>
                    <div class="grid gap-2">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-muted-foreground">Code:</span>
                            <div class="flex items-center gap-2">
                                <code class="bg-muted px-2 py-1 rounded text-xs" x-text="$store.app.session.sessionId || '---'">---</code>
                                <button onclick="app.copySessionInfo()" class="btn-sm-icon-outline" title="Copy session code">
                                    <i data-lucide="copy" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-muted-foreground">Riders:</span>
                            <span class="font-medium" x-text="$store.app.riderCount">0</span>
                        </div>
                    </div>
                </header>
                <section class="px-0">
                    <div class="riders-list">
                        <template x-if="!$store.app.session.participants.length">
                            <div style="color: var(--text-muted); text-align: center; padding: 1rem;">No riders</div>
                        </template>
                        <template x-for="participant in $store.app.session.participants" :key="participant.id">
                            <div style="padding: 0.75rem; border-bottom: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                    <div style="font-weight: 500;">
                                        <span x-text="participant.name"></span>
                                        <span class="badge-secondary" x-show="participant.isHost" style="font-size: 0.7rem; margin-left: 0.25rem; display: none;">HOST</span>
                                        <span class="badge-secondary" x-show="participant.isSelf" style="font-size: 0.7rem; margin-left: 0.25rem; background:#3b82f6; color:#fff; display: none;">YOU</span>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--muted-foreground);" x-text="participant.ftp + 'W'"></span>
                                </div>
                                <div style="display: flex; gap: 0.75rem; font-size: 0.875rem; color: var(--muted-foreground);">
                                    <span><i data-lucide="zap" style="width: 14px; height: 14px;"></i> <span x-text="participant.power"></span>W</span>
                                    <span><i data-lucide="gauge" style="width: 14px; height: 14px;"></i> <span x-text="participant.cadence"></span></span>
                                    <span><i data-lucide="heart" style="width: 14px; height: 14px;"></i> <span :style="{ color: participant.hrColor }" x-text="participant.heartRate || '--'"></span></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </section>
                <footer>
                    <button onclick="app.disconnectSession()" class="btn-destructive w-full">
                        <i data-lucide="log-out"></i>
                        <span>Leave Session</span>
                    </button>
                </footer>
            </div>

            <!-- Quick Control -->
            <div class="card">
                <header class="border-b border-border">
                    <h2 class="flex items-center gap-2 text-base font-semibold">
                        <i data-lucide="sliders" class="size-4 text-muted-foreground"></i>
                        <span>Quick Control</span>
                    </h2>
                </header>
                <section class="">
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <label for="powerSlider" id="quickControlLabel" class="text-sm font-medium">Target Power</label>
                            <div id="powerDisplay" class="text-3xl font-bold text-center py-4 bg-muted border border-border rounded-md tabular-nums">100W</div>
                            <input type="range" id="powerSlider" min="0" max="500" value="100" oninput="app.handleQuickControlInput()" onchange="app.handleQuickControlCommit()" class="input w-full">
                        </div>
                        <button onclick="app.handleQuickControlAction()" id="setPowerBtn" disabled class="btn w-full">
                            <i data-lucide="send"></i>
                            <span>Set Power</span>
                        </button>
                    </div>
                </section>
            </div>

            <!-- Workout Control -->
            <div class="card" id="workoutControlCard" style="display: none;">
                <header class="border-b border-border">
                    <h2 class="flex items-center gap-2 text-base font-semibold">
                        <i data-lucide="play-circle" class="size-4 text-muted-foreground"></i>
                        <span>Workout Ready</span>
                    </h2>
                </header>
                <section>
                    <div id="workoutReadyInfo" class="mb-4 text-sm text-muted-foreground">
                        <!-- Workout info will be shown here -->
                    </div>
                    <button onclick="workoutDesigner.startWorkout()" id="startWorkoutBtn" class="btn-lg w-full">
                        <i data-lucide="play"></i>
                        <span>Start Workout</span>
                    </button>
                    <!-- Host Control for sessions -->
                    <button onclick="app.startSyncedWorkout()" id="startSyncedBtnSidebar" class="btn-lg w-full mt-2" style="display: none;">
                        <i data-lucide="users"></i>
                        <span>Start for Everyone</span>
                    </button>
                </section>
            </div>

            <!-- Activity Log -->
            <details class="card activity-log-card" open>
                <summary class="activity-log-header" aria-label="Toggle activity log">
                    <div class="activity-log-title">
                        <div class="activity-log-icon">
                            <i data-lucide="terminal" class="size-4"></i>
                        </div>
                        <div class="activity-log-text">
                            <span class="activity-log-heading">Activity Log</span>
                            <span class="activity-log-subheading">Live events and connection updates</span>
                        </div>
                    </div>
                    <div class="activity-log-actions">
                        <span class="badge badge-success activity-log-live">
                            <span class="activity-log-live-dot"></span>
                            Live
                        </span>
                        <i data-lucide="chevron-down" class="chevron-rotate size-5"></i>
                    </div>
                </summary>
                <section class="activity-log-body">
                    <div id="log" class="activity-log-stream"></div>
                </section>
            </details>
        </div>
    </div>
    </div>

    <!-- Design Tab -->
    <div class="tab-content" id="content-design">
        <div class="max-w-[1600px] mx-auto p-6">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-foreground">Workout Designer</h1>
                <div class="flex items-center gap-2 bg-muted border border-border rounded-md px-3 py-2">
                    <label for="ftpInput" class="text-sm text-muted-foreground font-medium">FTP:</label>
                    <input type="number" id="ftpInput" value="200" min="50" max="500" onchange="app.updateFTP()" class="w-16 bg-transparent border-none text-sm font-semibold text-foreground text-center focus:outline-none focus:ring-2 focus:ring-ring rounded">
                    <span class="text-xs text-muted-foreground">W</span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-[1fr_280px] gap-6">
                <div class="space-y-6">
                    <div class="card">
                        <header class="border-b border-border">
                            <h2 class="flex items-center gap-2 text-base font-semibold">
                                <i data-lucide="layout" class="size-4 text-muted-foreground"></i>
                                <span>Build Your Workout</span>
                            </h2>
                        </header>
                        <section class="space-y-4">
                            <div class="flex flex-wrap gap-2">
                                <button onclick="workoutDesigner.addInterval('warmup')" class="btn-sm">
                                    <i data-lucide="sunrise"></i>
                                    <span>Warmup</span>
                                </button>
                                <button onclick="workoutDesigner.addInterval('endurance')" class="btn-sm">
                                    <i data-lucide="gauge"></i>
                                    <span>Endurance</span>
                                </button>
                                <button onclick="workoutDesigner.addInterval('tempo')" class="btn-sm">
                                    <i data-lucide="trending-up"></i>
                                    <span>Tempo</span>
                                </button>
                                <button onclick="workoutDesigner.addInterval('threshold')" class="btn-sm">
                                    <i data-lucide="flame"></i>
                                    <span>Threshold</span>
                                </button>
                                <button onclick="workoutDesigner.addInterval('vo2max')" class="btn-sm">
                                    <i data-lucide="rocket"></i>
                                    <span>VO2 Max</span>
                                </button>
                                <button onclick="workoutDesigner.addInterval('cooldown')" class="btn-sm">
                                    <i data-lucide="sunset"></i>
                                    <span>Cooldown</span>
                                </button>
                                <div class="flex-1"></div>
                                <button onclick="workoutDesigner.clearWorkout()" class="btn-sm-ghost">
                                    <i data-lucide="trash-2"></i>
                                    <span>Clear</span>
                                </button>
                            </div>
                            <div id="workoutTimeline" class="bg-muted border border-border rounded-md p-6 min-h-[180px]"></div>
                            <div class="flex items-center gap-6 p-4 bg-muted border border-border rounded-md">
                                <div class="flex items-center gap-2 text-sm text-muted-foreground font-medium">
                                    <i data-lucide="clock" class="size-4"></i>
                                    <span id="totalDuration" class="tabular-nums">0:00</span>
                                </div>
                                <div class="flex items-center gap-2 text-sm text-muted-foreground font-medium">
                                    <i data-lucide="gauge" class="size-4"></i>
                                    <span id="avgPower" class="tabular-nums">0</span>W avg
                                </div>
                                <div class="flex items-center gap-2 text-sm text-muted-foreground font-medium">
                                    <i data-lucide="flame" class="size-4"></i>
                                    <span id="totalWork" class="tabular-nums">0</span>kJ
                                </div>
                            </div>
                        </section>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="card">
                        <header class="border-b border-border">
                            <h2 class="flex items-center gap-2 text-base font-semibold">
                                <i data-lucide="save" class="size-4 text-muted-foreground"></i>
                                <span>Manage</span>
                            </h2>
                        </header>
                        <section class="space-y-2">
                            <button onclick="app.saveWorkout()" class="btn w-full">
                                <i data-lucide="save"></i>
                                <span>Save Workout</span>
                            </button>
                            <div class="pt-2 border-t border-border">
                                <div class="text-xs text-muted-foreground font-semibold uppercase tracking-wide mb-2">Import / Export</div>
                                <div class="space-y-2">
                                    <button onclick="app.exportWorkout()" class="btn-outline w-full text-sm">
                                        <i data-lucide="download"></i>
                                        <span>Export JSON</span>
                                    </button>
                                    <button onclick="app.importWorkout()" class="btn-outline w-full text-sm">
                                        <i data-lucide="upload"></i>
                                        <span>Import JSON</span>
                                    </button>
                                    <button onclick="app.exportZwo()" class="btn-outline w-full text-sm">
                                        <i data-lucide="download"></i>
                                        <span>Export ZWO</span>
                                    </button>
                                    <button onclick="app.importZwo()" class="btn-outline w-full text-sm">
                                        <i data-lucide="upload"></i>
                                        <span>Import ZWO</span>
                                    </button>
                                </div>
                            </div>
                            <button onclick="app.loadWorkoutForRide()" class="btn-outline w-full">
                                <i data-lucide="play"></i>
                                <span>Load & Ride</span>
                            </button>
                        </section>
                    </div>

                    <!-- AI Generation Help -->
                    <div class="card" x-data="{ expanded: false }">
                        <header class="border-b border-border cursor-pointer" @click="expanded = !expanded">
                            <h2 class="flex items-center justify-between text-base font-semibold">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="sparkles" class="size-4 text-muted-foreground"></i>
                                    <span>AI Workout Generator</span>
                                </div>
                                <i data-lucide="chevron-down" class="size-4 text-muted-foreground transition-transform" :class="{ 'rotate-180': expanded }"></i>
                            </h2>
                        </header>
                        <section class="space-y-3" x-show="expanded" x-collapse>
                            <div class="text-sm text-muted-foreground">
                                <p class="mb-3">Use ChatGPT or Claude to generate custom workouts! Copy the prompt below:</p>

                                <div class="relative">
                                    <pre class="bg-background border border-border rounded-md p-3 text-xs overflow-x-auto max-h-[300px] overflow-y-auto" id="aiPromptText">I need a cycling workout in JSON format for the Zwift Hub Controller app.

Please create a workout with the following requirements:
- Workout goal: [e.g., "Sweet spot endurance", "VO2 max intervals", "FTP test"]
- Duration: [e.g., "60 minutes", "90 minutes"]
- Difficulty level: [e.g., "beginner", "intermediate", "advanced"]
- Special requirements: [any specific needs]

The JSON format should follow this structure:

{
  "name": "Workout Name",
  "description": "Brief description of the workout",
  "ftp": 200,
  "intervals": [
    {
      "name": "Interval Name",
      "type": "warmup|endurance|tempo|threshold|vo2max|cooldown",
      "duration": 300,
      "powerType": "relative|absolute|ramp",
      "percentage": 60  // for relative power
      // OR
      "power": 150  // for absolute power in watts
      // OR for ramps:
      "percentageLow": 50,
      "percentageHigh": 80
    }
  ],
  "created": "2025-01-15T12:00:00.000Z",
  "version": "1.0"
}

Power type rules:
- relative (% of FTP): Use for most intervals. Percentage between 10-200.
- absolute (fixed watts): Use for specific power targets or ramp tests.
- ramp (gradual increase): Use percentageLow and percentageHigh for smooth power transitions.

Interval types and typical power zones:
- warmup: 40-60% FTP
- endurance: 55-75% FTP
- tempo: 76-87% FTP
- threshold: 88-105% FTP
- vo2max: 106-120% FTP
- cooldown: 40-50% FTP

Please ensure:
1. Workout starts with a proper warmup (10-15 minutes)
2. Include recovery periods between hard efforts
3. End with an adequate cooldown (10 minutes)
4. Total duration matches my request
5. Progression is logical and safe

Return only the valid JSON, no additional explanation.</pre>
                                    <button onclick="navigator.clipboard.writeText(document.getElementById('aiPromptText').textContent)"
                                            class="absolute top-2 right-2 px-2 py-1 bg-muted hover:bg-accent border border-border rounded text-xs font-medium transition-colors">
                                        <i data-lucide="copy" class="size-3 inline"></i>
                                        Copy
                                    </button>
                                </div>

                                <div class="mt-3 p-3 bg-muted border border-border rounded-md text-xs">
                                    <div class="font-semibold mb-1 flex items-center gap-1">
                                        <i data-lucide="info" class="size-3"></i>
                                        How to use:
                                    </div>
                                    <ol class="list-decimal list-inside space-y-1 ml-1">
                                        <li>Copy the prompt above</li>
                                        <li>Paste into ChatGPT or Claude</li>
                                        <li>Fill in your workout requirements</li>
                                        <li>Copy the generated JSON</li>
                                        <li>Use "Import JSON" button to load it</li>
                                    </ol>
                                </div>

                                <div class="flex flex-col gap-2 mt-3">
                                    <a href="WORKOUT-GENERATION-PROMPT.md" target="_blank" class="inline-flex items-center gap-1 text-xs text-primary hover:underline">
                                        <i data-lucide="file-text" class="size-3"></i>
                                        View full prompt guide
                                        <i data-lucide="external-link" class="size-3"></i>
                                    </a>
                                    <a href="https://www.zwiftworkout.com/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-xs text-primary hover:underline">
                                        <i data-lucide="edit-3" class="size-3"></i>
                                        Create workout with Zwift Workout Editor
                                        <i data-lucide="external-link" class="size-3"></i>
                                    </a>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workouts Tab -->
    <div class="tab-content" id="content-workouts">
        <div class="max-w-[1600px] mx-auto p-6">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-foreground">Workout Library</h1>
                <button onclick="app.importWorkout()" class="btn">
                    <i data-lucide="upload"></i>
                    <span>Import Workout</span>
                </button>
            </div>
            <div id="workoutLibrary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Workout cards will be generated here -->
            </div>
        </div>
    </div>

    <!-- Session Tab -->
    <div class="tab-content" id="content-session">
        <div class="max-w-[1400px] mx-auto p-8">
            <div class="mb-8">
                <h1 class="text-2xl font-bold text-foreground mb-2">Ride with Friends</h1>
            </div>

            <!-- Not Connected State -->
            <div id="sessionNotConnected" class="space-y-6">
                <div class="text-center p-12 bg-card border border-border rounded-lg mb-6">
                    <i data-lucide="users" class="w-16 h-16 mx-auto mb-6 text-primary opacity-50"></i>
                    <h2 class="text-xl font-bold text-foreground mb-2">Train Together, Ride Stronger</h2>
                    <p class="text-base text-muted-foreground max-w-2xl mx-auto">Create or join a session to ride with friends. See each other's power, cadence, and race on the same workout!</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <header class="border-b border-border">
                            <h2 class="flex items-center gap-2 text-base font-semibold">
                                <i data-lucide="plus-circle" class="size-4 text-muted-foreground"></i>
                                <span>Create Session</span>
                            </h2>
                        </header>
                        <section class="space-y-4">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-muted-foreground">Your Name</label>
                                <input type="text" id="hostNameInput" placeholder="Enter your name" value="Rider" class="w-full p-3 bg-muted border border-border rounded-md text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring">
                            </div>
                            <button onclick="app.createSession()" class="btn-lg w-full">
                                <i data-lucide="play-circle"></i>
                                <span>Create Session</span>
                            </button>
                        </section>
                    </div>

                    <div class="card">
                        <header class="border-b border-border">
                            <h2 class="flex items-center gap-2 text-base font-semibold">
                                <i data-lucide="user-plus" class="size-4 text-muted-foreground"></i>
                                <span>Join Session</span>
                            </h2>
                        </header>
                        <section class="space-y-4">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-muted-foreground">Your Name</label>
                                <input type="text" id="joinNameInput" placeholder="Enter your name" value="Rider" class="w-full p-3 bg-muted border border-border rounded-md text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring">
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-muted-foreground">Session Code</label>
                                <input type="text" id="sessionCodeInput" placeholder="e.g., swift-mountain-climbing-falcon" class="w-full p-3 bg-muted border border-border rounded-md text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring">
                                <p class="text-xs text-muted-foreground">Paste the full session code from your friend</p>
                            </div>
                            <button onclick="app.joinSession()" class="btn-lg w-full">
                                <i data-lucide="log-in"></i>
                                <span>Join Session</span>
                            </button>
                        </section>
                    </div>
                </div>
            </div>

            <!-- Connected State -->
            <div id="sessionConnected" class="space-y-6" style="display: none;">
                <div class="flex items-center gap-4 bg-card border border-border rounded-lg">
                    <div class="flex items-center gap-3 flex-1">
                        <span class="text-sm text-muted-foreground font-medium">Session Code:</span>
                        <code id="sessionCodeDisplay" class="px-3 py-1.5 bg-muted text-primary font-mono text-sm rounded-md">---</code>
                        <button onclick="app.copySessionInfo()" class="btn-sm-icon-outline" title="Copy Session Code">
                            <i data-lucide="copy"></i>
                        </button>
                    </div>
                    <button onclick="app.disconnectSession()" class="btn-destructive">
                        <i data-lucide="log-out"></i>
                        <span>Leave Session</span>
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- My FTP Settings -->
                    <div class="card">
                        <header class="border-b border-border">
                            <h2 class="flex items-center gap-2 text-base font-semibold">
                                <i data-lucide="gauge" class="size-4 text-muted-foreground"></i>
                                <span>My FTP</span>
                            </h2>
                        </header>
                        <section class="space-y-4">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-muted-foreground">Your FTP (Watts)</label>
                                <input type="number" id="sessionFtpInput" value="200" min="50" max="500" onchange="app.updateSessionFTP()" class="w-full p-3 bg-muted border border-border rounded-md text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring">
                                <p class="text-xs text-muted-foreground">Workout will scale to your FTP. You can adjust this anytime!</p>
                            </div>
                        </section>
                    </div>

                    <!-- Video Chat Section -->
                    <div class="card">
                        <header class="border-b border-border">
                            <h2 class="flex items-center gap-2 text-base font-semibold">
                                <i data-lucide="video" class="size-4 text-muted-foreground"></i>
                                <span>Video Chat</span>
                            </h2>
                        </header>
                        <section class="space-y-4">
                            <p class="text-sm text-muted-foreground">Connect with your friends via Google Meet:</p>
                            <div class="space-y-2">
                                <input type="text" id="meetLinkInput" placeholder="Paste Google Meet link" class="w-full p-3 bg-muted border border-border rounded-md text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring">
                                <button onclick="app.openMeetLink()" class="btn w-full">
                                    <i data-lucide="external-link"></i>
                                    <span>Open Google Meet</span>
                                </button>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Race Track -->
                <div class="card">
                    <header class="border-b border-border">
                        <h2 class="flex items-center gap-2 text-base font-semibold">
                            <i data-lucide="flag" class="size-4 text-muted-foreground"></i>
                            <span>Race Track</span>
                        </h2>
                    </header>
                    <section class="p-6">
                        <canvas id="raceTrackCanvas" width="1000" height="300" class="w-full h-[300px] bg-muted rounded-md"></canvas>
                    </section>
                </div>

                <!-- Participants List -->
                <div class="card">
                    <header class="border-b border-border">
                        <h2 class="flex items-center gap-2 text-base font-semibold">
                            <i data-lucide="users" class="size-4 text-muted-foreground"></i>
                            <span>Participants</span>
                        </h2>
                    </header>
                    <section class="p-6">
                        <div class="space-y-3">
                            <template x-if="!$store.app.session.participants.length">
                                <div style="color: var(--text-muted); text-align: center; padding: 2rem;">No participants yet</div>
                            </template>
                            <template x-for="participant in $store.app.session.participants" :key="participant.id">
                                <div class="participant-card" :class="{ 'host': participant.isHost }">
                                    <div class="participant-info">
                                        <div class="participant-name">
                                            <span x-text="participant.name"></span>
                                            <span class="host-badge" x-show="participant.isHost" style="display: none;">HOST</span>
                                            <span class="host-badge" x-show="participant.isSelf" style="background:#3b82f6; color:#fff; display: none;">YOU</span>
                                            <span class="ftp-badge" x-text="participant.ftp + 'W FTP'"></span>
                                        </div>
                                        <div class="participant-metrics">
                                            <span><i data-lucide="zap"></i> <span x-text="participant.power"></span>W</span>
                                            <span><i data-lucide="gauge"></i> <span x-text="participant.cadence"></span> rpm</span>
                                            <span><i data-lucide="heart"></i> <span :style="{ color: participant.hrColor }" x-text="participant.heartRate || '--'"></span></span>
                                        </div>
                                    </div>
                                    <div class="participant-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" :style="{ width: (participant.progress * 100) + '%' }"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script src="ftms.js"></script>
    <script src="chart.js"></script>
    <script src="workout-preview.js"></script>
    <script src="workout-progress.js"></script>
    <script src="workout-recorder.js"></script>
    <script src="workout-designer.js"></script>
    <script src="hr-zones.js"></script>
    <script src="session-p2p.js"></script>
    <script src="racetrack.js"></script>
    <script src="zwo-converter.js"></script>
    <script src="app.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        // Draw workout previews after DOM is loaded
        setTimeout(() => WorkoutPreview.refreshAllPreviews(), 100);

        // Initialize range sliders with Basecoat styling
        (() => {
            const sliders = document.querySelectorAll('input[type="range"].input');
            if (!sliders) return;

            const updateSlider = (el) => {
                const min = parseFloat(el.min || 0);
                const max = parseFloat(el.max || 100);
                const value = parseFloat(el.value);
                const percent = (max === min) ? 0 : ((value - min) / (max - min)) * 100;
                el.style.setProperty('--slider-value', `${percent}%`);
            };

            sliders.forEach(slider => {
                updateSlider(slider);
                slider.addEventListener('input', (event) => updateSlider(event.target));
            });
        })();
    </script>
</body>
</html>
